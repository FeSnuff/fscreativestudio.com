<style>
body { background: #f5f5f5; min-height: 100vh; margin: 0; font-family: Arial, sans-serif; }
.vista3-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
.vista3-header { background: #fff; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.header-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
.view-options { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
.radio-view { display: flex; align-items: center; gap: 10px; padding: 10px 20px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; background: #fff; }
.radio-view input { width: 18px; height: 18px; cursor: pointer; }
.radio-view.selected { border-color: #667eea; background: #f0f4ff; }
.color-picker-group { display: flex; align-items: center; gap: 10px; }
.color-picker-group label { font-weight: 600; color: #333; }
.color-picker-group input[type="color"] { width: 50px; height: 40px; border: 2px solid #e0e0e0; border-radius: 5px; cursor: pointer; }
.action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
.btn-back { background: #6c757d; color: white; }
.btn-edit { background: #ffc107; color: #333; }
.btn-pdf { background: #28a745; color: white; }
.btn-cancel { background: #dc3545; color: white; }
.btn-logout { background: #343a40; color: white; }
.document { background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.doc-header { border-bottom: 3px solid var(--primary-color, #667eea); padding-bottom: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; gap: 15px; page-break-after: avoid; }
.doc-header-left { display: flex; align-items: center; gap: 12px; }
.doc-logo-img { width: 70px; height: 70px; object-fit: contain; }
.doc-logo-text { display: flex; flex-direction: column; }
.doc-logo-title { font-size: 22px; font-weight: bold; color: var(--primary-color, #667eea); line-height: 1.2; }
.doc-logo-subtitle { font-size: 13px; color: #666; margin-top: 3px; }
.doc-header-right { text-align: right; color: #666; font-size: 12px; line-height: 1.5; }
.doc-header-right a { color: var(--primary-color, #667eea); text-decoration: none; }
.doc-title { font-size: 20px; font-weight: bold; color: #333; text-align: center; margin-bottom: 15px; page-break-after: avoid; }
.first-page-content { page-break-inside: avoid; }
.itinerary-section { margin-bottom: 30px; }
.section-title { font-size: 18px; font-weight: bold; color: var(--primary-color, #667eea); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--primary-color, #667eea); }
.day-item { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary-color, #667eea); }
.day-item.first-day { margin-bottom: 20px; padding: 15px; }
.day-title { font-size: 16px; font-weight: bold; color: var(--primary-color, #667eea); margin-bottom: 8px; }
.tour-name-day { font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px; }
.tour-image-detail { width: 100%; height: 200px; border-radius: 8px; object-fit: cover; margin-bottom: 15px; background: linear-gradient(135deg, #667eea, #764ba2); }
.tour-summary { color: #666; line-height: 1.6; margin-bottom: 15px; }
.includes-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
.includes-list { background: #fff; padding: 12px; border-radius: 8px; }
.includes-list h4 { color: #28a745; margin-bottom: 8px; font-size: 13px; }
.not-includes-list h4 { color: #dc3545; margin-bottom: 8px; font-size: 13px; }
.includes-list ul { list-style: none; padding: 0; margin: 0; }
.includes-list li { padding: 4px 0; font-size: 12px; color: #666; }
.not-includes-list { background: #fff; padding: 12px; border-radius: 8px; }
.not-includes-list ul { list-style: none; padding: 0; margin: 0; }
.not-includes-list li { padding: 4px 0; font-size: 12px; color: #666; }
.cost-summary { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.cost-summary-wrapper { page-break-inside: avoid !important; margin-bottom: 20px; }
.client-info-compact { background: #f8f9fa; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 25px; flex-wrap: wrap; align-items: center; justify-content: space-around; }
.client-info-item { display: flex; gap: 5px; font-size: 13px; }
.client-info-item strong { color: #333; }
.client-info-item span { color: #666; }
.cost-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e0e0e0; }
.cost-total { display: flex; justify-content: space-between; padding: 15px 0; font-size: 20px; font-weight: bold; color: var(--primary-color, #667eea); margin-top: 10px; }
.validity { background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px; color: #856404; }
.payment-methods { margin-bottom: 20px; }
.payment-images { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; justify-content: center; }
.payment-images img { height: 40px; border-radius: 5px; }
.terms { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
.terms h3 { color: #333; margin-bottom: 10px; font-size: 16px; }
.terms ul { color: #666; line-height: 1.5; font-size: 11px; margin: 0; padding-left: 20px; }
.terms li { margin-bottom: 6px; }
.doc-footer { border-top: 2px solid var(--primary-color, #667eea); padding-top: 20px; margin-top: 30px; text-align: center; color: #666; font-size: 12px; line-height: 1.6; }

/* Page break container - agrupa secciones finales */
.final-page-section { 
    page-break-inside: avoid;
}

/* Page guides - gu√≠as visuales de p√°gina A4 */
.page-guide { position: relative; }
.page-guide::after { content: 'L√≠mite de p√°gina A4'; position: absolute; left: 0; right: 0; height: 2px; background: repeating-linear-gradient(to right, #e74c3c 0, #e74c3c 10px, transparent 10px, transparent 20px); pointer-events: none; opacity: 0.4; z-index: 10; font-size: 10px; color: #e74c3c; text-align: center; }
.page-guide-1::after { top: 1050px; }
.page-guide-2::after { top: 2100px; }
.page-guide-3::after { top: 3150px; }
.editable-mode { outline: 2px dashed #ffc107; background: #fffbf0; }
.activity-list { background: #fff; padding: 12px; border-radius: 8px; margin-top: 8px; margin-bottom: 10px; }
.activity-list h4 { color: var(--primary-color, #667eea); margin-bottom: 8px; font-size: 13px; }
.activity-list ul { list-style: none; padding: 0; margin: 0; }
.activity-list li { padding: 4px 0; font-size: 12px; color: #666; }
.activity-list li:before { content: "üìç "; }
@media (max-width: 768px) {
    .includes-section { grid-template-columns: 1fr; }
    .document { padding: 20px; }
    .action-buttons { width: 100%; }
    .btn { flex: 1; }
    .doc-header { flex-direction: column; text-align: center; }
    .doc-header-right { text-align: center; }
}
</style>

<div class="vista3-container">
    <div class="vista3-header">
        <div class="header-controls">
            <div class="view-options">
                <div class="radio-view selected" id="viewResumen" onclick="selectView('resumen')">
                    <input type="radio" name="viewType" value="resumen" checked>
                    <span>üìÑ Resumen</span>
                </div>
                <div class="radio-view" id="viewDetallado" onclick="selectView('detallado')">
                    <input type="radio" name="viewType" value="detallado">
                    <span>üìã Detallado</span>
                </div>
                <div class="color-picker-group">
                    <label>Color:</label>
                    <input type="color" id="primaryColor" value="#667eea" onchange="updatePrimaryColor()">
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-back" onclick="loadView('vista2')">‚Üê Anterior</button>
                <button class="btn btn-edit" id="btnEdit" onclick="toggleEditMode()">‚úèÔ∏è Editar</button>
                <button class="btn btn-pdf" id="btnPDF" onclick="generatePDF()">üì• Generar PDF</button>
                <button class="btn" id="btnSave" onclick="saveItinerary()" style="background:#17a2b8;color:white">üíæ Guardar Itinerario</button>
                <button class="btn btn-cancel" onclick="confirmCancel()">‚ùå Cancelar</button>
                <button class="btn btn-logout" onclick="logout()">üö™ Salir</button>
            </div>
        </div>
    </div>
    
    <div class="document" id="documentContent"></div>
</div>

<script>
// Use global variables (no let/const)
currentView = 'resumen';
primaryColor = '#667eea';
isEditMode = false;

function toggleEditMode() {
    isEditMode = !isEditMode;
    const doc = document.getElementById('documentContent');
    const btn = document.getElementById('btnEdit');
    
    if (isEditMode) {
        doc.contentEditable = 'true';
        doc.classList.add('editable-mode');
        btn.innerHTML = '‚úÖ Terminar Edici√≥n';
        btn.style.background = '#28a745';
    } else {
        doc.contentEditable = 'false';
        doc.classList.remove('editable-mode');
        btn.innerHTML = '‚úèÔ∏è Editar';
        btn.style.background = '#ffc107';
    }
}

function selectView(view) {
    currentView = view;
    document.getElementById('viewResumen').classList.toggle('selected', view === 'resumen');
    document.getElementById('viewDetallado').classList.toggle('selected', view === 'detallado');
    document.querySelectorAll('input[name="viewType"]').forEach(radio => {
        radio.checked = radio.value === view;
    });
    renderDocument();
}

function updatePrimaryColor() {
    primaryColor = document.getElementById('primaryColor').value;
    document.documentElement.style.setProperty('--primary-color', primaryColor);
}

function renderDocument() {
    const vista2 = VISTA2_DATA || {};
    const currency = vista2.currency === 'USD' ? '$' : 'S/';
    const baseTotal = CART.reduce((acc, t) => acc + t.price, 0);
    const totalDays = CART.reduce((acc, t) => acc + t.duration_days, 0);
    const totalNights = totalDays - 1;
    
    let adultTotal = vista2.totalAmount || baseTotal;
    let childTotal = 0;
    
    if (vista2.includeBudgetChild) {
        const baseAmount = baseTotal;
        if (vista2.currency === 'USD') {
            adultTotal = baseAmount / 3.75;
            childTotal = (baseAmount * 0.5) / 3.75;
        } else {
            adultTotal = baseAmount;
            childTotal = baseAmount * 0.5;
        }
    }
    
    let currentDay = 1;
    let daysHTML = '';
    
    CART.forEach((tour, index) => {
        const days = tour.duration_days;
        const dayLabel = days === 1 ? `D√≠a ${currentDay}` : `D√≠as ${currentDay} - ${currentDay + days - 1}`;
        const isFirstDay = index === 0;
        
        // Summary list (always show)
        const summaryList = tour.summary_list || [];
        const summaryHTML = summaryList.length > 0 ? `
            <div class="activity-list">
                <h4>üìã Itinerario:</h4>
                <ul>
                    ${summaryList.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
        ` : '';
        
        if (currentView === 'resumen') {
            daysHTML += `
                <div class="day-item ${isFirstDay ? 'first-day' : ''}">
                    <div class="day-title">${dayLabel}</div>
                    <div class="tour-name-day">${tour.name}</div>
                    ${summaryHTML}
                    ${renderIncludes(tour)}
                </div>
            `;
        } else {
            const imageName = tour.name.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/√±/g, 'n')
                .replace(/[\s\-‚Äî‚Äì]+/g, '_');
            const imageUrl = IMAGE_CACHE[tour.name] || `images/${imageName}/Principal.jpg`;
            
            daysHTML += `
                <div class="day-item ${isFirstDay ? 'first-day' : ''}">
                    <div class="day-title">${dayLabel}</div>
                    <div class="tour-name-day">${tour.name}</div>
                    <img src="${imageUrl}" class="tour-image-detail" alt="${tour.name}" onerror="this.style.background='linear-gradient(135deg, #667eea, #764ba2)'; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3C/svg%3E'">
                    <div class="tour-summary">${tour.summary || 'Disfruta de una experiencia √∫nica en este tour.'}</div>
                    ${summaryHTML}
                    ${renderIncludes(tour)}
                </div>
            `;
        }
        
        currentDay += days;
    });
    
    document.getElementById('documentContent').innerHTML = `
        <div class="first-page-content">
            <div class="doc-header">
                <div class="doc-header-left">
                    <img src="images/logo.png" alt="Qori Wayra Logo" class="doc-logo-img" onerror="this.style.display='none'">
                    <div class="doc-logo-text">
                        <div class="doc-logo-title">Qori Wayra - Travel</div>
                        <div class="doc-logo-subtitle">Experiencias √∫nicas en Cusco y Per√∫</div>
                    </div>
                </div>
                <div class="doc-header-right">
                    Tel: <a href="tel:+51924377454">+51 924 377 454</a><br>
                    Web: <a href="https://qoriwayra-travel.com" target="_blank">qoriwayra-travel.com</a><br>
                    Email: <a href="mailto:qoriwayra.cuscotravel@gmail.com">qoriwayra.cuscotravel@gmail.com</a><br>
                    Instagram: <a href="https://instagram.com/qoriwayratravel" target="_blank">@qoriwayratravel</a>
                </div>
            </div>
            
            <div class="doc-title">ITINERARIO DE VIAJE<br><span style="font-size:16px;color:#666">${totalDays} d√≠a${totalDays > 1 ? 's' : ''} / ${totalNights} noche${totalNights > 1 ? 's' : ''}</span></div>
        </div>
        
        ${vista2.includeClientData ? `
        <div class="client-info-section">
            <div class="section-title">üë§ Informaci√≥n del Cliente</div>
            <div class="client-info-compact">
                <div class="client-info-item">
                    <strong>Nombre:</strong>
                    <span>${vista2.clientName}</span>
                </div>
                <div class="client-info-item">
                    <strong>Nacionalidad:</strong>
                    <span>${vista2.clientNationality ? vista2.clientNationality.split('|')[0] : ''}</span>
                </div>
                <div class="client-info-item">
                    <strong>Contacto:</strong>
                    <span>${vista2.phonePrefix}${vista2.phoneNumber}</span>
                </div>
            </div>
        </div>
        ` : ''}
        
        <div class="itinerary-section page-guide page-guide-1 page-guide-2 page-guide-3">
            <div class="section-title">üìÖ Cronograma</div>
            ${daysHTML}
        </div>
        
        <div class="final-page-section">
            <div class="cost-summary-wrapper">
                <div class="section-title">üí∞ Resumen de Costos</div>
                <div class="cost-summary">
                <div class="cost-row">
                    <span>Cantidad de Tours:</span>
                    <span>${CART.length}</span>
                </div>
                <div class="cost-row">
                    <span>Moneda:</span>
                    <span>${vista2.currency === 'USD' ? 'D√≥lares (USD)' : 'Soles (PEN)'}</span>
                </div>
                ${vista2.includeBudgetChild ? `
                <div class="cost-total" style="margin-top:10px;padding-top:10px;border-top:2px solid #e0e0e0">
                    <span>TOTAL ADULTO:</span>
                    <span>${currency} ${adultTotal.toFixed(2)}</span>
                </div>
                <div class="cost-total" style="margin-top:0;padding-top:10px">
                    <span>TOTAL NI√ëO:</span>
                    <span>${currency} ${childTotal.toFixed(2)}</span>
                </div>
                ` : `
                <div class="cost-total">
                    <span>TOTAL A PAGAR:</span>
                    <span>${currency} ${adultTotal.toFixed(2)}</span>
                </div>
                `}
            </div>
            </div>
            
            <div class="validity">
                ‚è∞ <strong>Validez:</strong> Este presupuesto tiene una validez de 2 d√≠as desde su emisi√≥n.
            </div>
            
            <div class="payment-methods">
                <div class="section-title">üí≥ M√©todos de Pago</div>
                <div class="payment-images">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png" alt="Visa">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal">
                    <img src="https://images.seeklogo.com/logo-png/49/1/western-union-2023-logo-png_seeklogo-499195.png" alt="Western Union">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/76/Yape_peru_logotype.svg/1200px-Yape_peru_logotype.svg.png" alt="Yape">
                </div>
            </div>
            
            <div class="terms">
                <h3>üìã T√©rminos y Condiciones</h3>
                <ul>
                    <li><strong>Reserva y adelanto:</strong> Para confirmar tu reserva, solicitamos un adelanto del 50% del monto total. Este adelanto asegura la disponibilidad de los servicios contratados.</li>
                    <li><strong>Pagos internacionales:</strong> Los pagos realizados con tarjetas extranjeras a trav√©s de PayPal u otros medios internacionales tienen un cargo adicional del 5% al 10% seg√∫n la plataforma utilizada.</li>
                    <li><strong>Pol√≠tica de cancelaci√≥n:</strong> Entendemos que los planes pueden cambiar. Las cancelaciones realizadas con anticipaci√≥n razonable (sugerimos al menos 15-30 d√≠as antes del tour) pueden ser evaluadas caso por caso. Sin embargo, el adelanto del 50% cubre costos operativos ya incurridos y generalmente no es reembolsable.</li>
                    <li><strong>Reembolsos por circunstancias de la empresa:</strong> Si por causas atribuibles a nuestra agencia no podemos realizar el servicio contratado, procederemos al reembolso total del adelanto o reprogramaci√≥n sin costo adicional.</li>
                    <li><strong>Condiciones clim√°ticas y situaciones extraordinarias:</strong> Los tours pueden verse afectados por condiciones clim√°ticas adversas, emergencias o situaciones fuera de nuestro control. En estos casos, haremos nuestro mejor esfuerzo para reprogramar sin cargo adicional. Estas circunstancias naturales no est√°n cubiertas por pol√≠ticas de reembolso.</li>
                    <li><strong>Cambios de itinerario del cliente:</strong> Si necesitas modificar fechas por razones personales, trabajaremos contigo para encontrar nuevas fechas sujetas a disponibilidad. Los cambios pueden generar costos adicionales seg√∫n los proveedores.</li>
                    <li><strong>Disponibilidad de servicios:</strong> Todos nuestros tours est√°n sujetos a disponibilidad de proveedores y confirmaci√≥n final.</li>
                    <li><strong>Responsabilidad del viajero:</strong> Es responsabilidad del cliente contar con la documentaci√≥n necesaria (pasaporte vigente, visas, seguros de viaje, etc.) para realizar los tours.</li>
                </ul>
            </div>
            
            <div class="doc-footer">
                <strong>Documento generado por Qori Wayra - Travel</strong><br>
                Todos los tours est√°n sujetos a disponibilidad y condiciones clim√°ticas<br>
                Para m√°s informaci√≥n, cont√°ctenos a trav√©s de nuestros canales oficiales
            </div>
        </div>
    `;
}

function renderIncludes(tour) {
    const includes = tour.includes || [];
    const notIncludes = tour.excludes || tour.not_includes || [];
    
    return `
        <div class="includes-section">
            <div class="includes-list">
                <h4>‚úì Incluye:</h4>
                <ul>
                    ${includes.length > 0 ? includes.map(item => `<li>${getEmojiForItem(item, true)} ${item}</li>`).join('') : '<li>No especificado</li>'}
                </ul>
            </div>
            <div class="not-includes-list">
                <h4>‚úó No Incluye:</h4>
                <ul>
                    ${notIncludes.length > 0 ? notIncludes.map(item => `<li>${getEmojiForItem(item, false)} ${item}</li>`).join('') : '<li>No especificado</li>'}
                </ul>
            </div>
        </div>
    `;
}

function confirmCancel() {
    if (confirm('¬øEst√°s seguro de que deseas cancelar? Se perder√°n todos los datos.')) {
        clearAllData();
        loadView('vistatours');
    }
}

async function saveItinerary() {
    const btnSave = document.getElementById('btnSave');
    btnSave.disabled = true;
    btnSave.textContent = '‚è≥ Guardando...';
    
    try {
        console.log('=== INICIANDO GUARDADO DE ITINERARIO ===');
        
        const vista2 = VISTA2_DATA || {};
        const totalDays = CART.reduce((acc, t) => acc + t.duration_days, 0);
        const currency = vista2.currency === 'USD' ? '$' : 'S/';
        const adultTotal = vista2.adultTotal || vista2.totalAmount || CART.reduce((acc, t) => acc + t.price, 0);
        const childTotal = vista2.childTotal || 0;
        const total = adultTotal + childTotal;
        
        console.log('Datos del cliente:', {
            nombre: vista2.clientName,
            nacionalidad: vista2.clientNationality,
            telefono: `${vista2.phonePrefix}${vista2.phoneNumber}`
        });
        
        console.log('Tours en el carrito:', CART.map(t => t.name));
        console.log('Total d√≠as:', totalDays);
        console.log('Total a pagar:', `${currency} ${total.toFixed(2)}`);
        
        // Generate encoded itinerary
        console.log('Generando c√≥digo cifrado...');
        const encodedItinerary = window.encodeItinerary();
        console.log('C√≥digo generado:', encodedItinerary);
        
        // Prepare data for Google Sheets
        const itineraryData = {
            fecha: new Date().toISOString(),
            cliente: vista2.clientName || 'Sin nombre',
            nacionalidad: vista2.clientNationality ? vista2.clientNationality.split('|')[0] : 'N/A',
            telefono: vista2.phonePrefix && vista2.phoneNumber ? `${vista2.phonePrefix}${vista2.phoneNumber}` : 'N/A',
            tours: CART.map(t => t.name).join(', '),
            dias: totalDays,
            total: `${currency} ${total.toFixed(2)}`,
            moneda: vista2.currency || 'PEN',
            codigo: encodedItinerary,
            usuario: USER || 'An√≥nimo'
        };
        
        console.log('Datos a enviar al servidor:', itineraryData);
        
        // Send to Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyhy2orKUdaAUDp91lNQ5ertl28xLLpAgiSzORLQWfXXaju4rbLjU8TCqU9XSf3J7_3YQ/exec';
        
        console.log('Enviando a Google Apps Script...');
        console.log('URL:', SCRIPT_URL);
        
        const payload = {
            action: 'saveItinerary',
            data: itineraryData
        };
        
        console.log('Payload completo:', JSON.stringify(payload, null, 2));
        
        console.log('Enviando POST request...');
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });
        
        console.log('Respuesta recibida (no-cors):', response);
        console.log('Status:', response.status);
        console.log('Type:', response.type);
        
        // Con no-cors no podemos leer la respuesta, pero si lleg√≥ aqu√≠ se envi√≥
        console.log('‚úÖ Petici√≥n POST enviada');
        console.log('üìã Guardado en Google Sheet');
        
        btnSave.disabled = true;
        btnSave.textContent = '‚úÖ Guardado';
        btnSave.style.background = '#10b981';
        btnSave.style.cursor = 'not-allowed';
        
    } catch (error) {
        console.error('‚ùå ERROR AL GUARDAR:', error);
        console.error('Mensaje de error:', error.message);
        console.error('Stack trace:', error.stack);
        btnSave.disabled = false;
        btnSave.textContent = 'üíæ Guardar Itinerario';
        alert('‚ùå Error al guardar itinerario: ' + error.message);
    }
}

async function generatePDF() {
    const btnPDF = document.getElementById('btnPDF');
    btnPDF.disabled = true;
    btnPDF.textContent = '‚è≥ Generando PDF...';
    
    try {
        // Load html2pdf library
        if (!window.html2pdf) {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
            await new Promise((resolve, reject) => {
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const element = document.getElementById('documentContent');
        
        if (!element) {
            throw new Error('No se encontr√≥ el contenido del documento');
        }
        
        // Clone element for PDF
        const clone = element.cloneNode(true);
        
        // Add CSS for better page breaks
        const style = document.createElement('style');
        style.textContent = `
            @media print {
                .page-guide::after { display: none !important; }
            }
            
            /* Primera p√°gina unida */
            .first-page-content {
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            .doc-header {
                page-break-after: avoid !important;
                margin-bottom: 10px !important;
                padding-bottom: 10px !important;
            }
            
            .doc-title {
                page-break-after: avoid !important;
                margin-bottom: 10px !important;
                font-size: 18px !important;
            }
            
            .doc-title span {
                font-size: 14px !important;
            }
            
            /* Cliente info compacto */
            .client-info-section {
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            .client-info-section .section-title {
                font-size: 15px !important;
                margin-bottom: 6px !important;
                padding-bottom: 5px !important;
            }
            
            .client-info-compact {
                margin-bottom: 10px !important;
                padding: 8px 12px !important;
            }
            
            .client-info-item {
                font-size: 11px !important;
            }
            
            /* Primer d√≠a EXTRA compacto y unido */
            .day-item.first-day {
                page-break-before: avoid !important;
                page-break-inside: avoid !important;
                padding: 8px !important;
                margin-bottom: 12px !important;
            }
            
            .first-day .day-title {
                font-size: 13px !important;
                margin-bottom: 4px !important;
            }
            
            .first-day .tour-name-day {
                font-size: 12px !important;
                margin-bottom: 4px !important;
            }
            
            .first-day .activity-list {
                padding: 6px !important;
                margin-top: 4px !important;
                margin-bottom: 4px !important;
            }
            
            .first-day .activity-list h4 {
                font-size: 11px !important;
                margin-bottom: 4px !important;
            }
            
            .first-day .activity-list ul {
                margin: 0 !important;
            }
            
            .first-day .activity-list li {
                font-size: 10px !important;
                padding: 2px 0 !important;
                line-height: 1.3 !important;
            }
            
            .first-day .includes-section {
                gap: 8px !important;
                margin-top: 4px !important;
            }
            
            .first-day .includes-list,
            .first-day .not-includes-list {
                padding: 6px !important;
            }
            
            .first-day .includes-list h4,
            .first-day .not-includes-list h4 {
                font-size: 11px !important;
                margin-bottom: 4px !important;
            }
            
            .first-day .includes-list ul,
            .first-day .not-includes-list ul {
                margin: 0 !important;
            }
            
            .first-day .includes-list li,
            .first-day .not-includes-list li {
                font-size: 9px !important;
                padding: 2px 0 !important;
                line-height: 1.3 !important;
            }
            
            /* Evitar saltos de p√°gina dentro de estos elementos */
            .day-item { 
                page-break-inside: avoid !important; 
                margin-bottom: 20px !important;
            }
            .includes-section { 
                page-break-inside: avoid !important; 
            }
            .activity-list { 
                page-break-inside: avoid !important; 
            }
            
            /* La secci√≥n final debe fluir naturalmente sin forzar salto */
            .final-page-section {
                page-break-inside: avoid !important;
                margin-top: 20px !important;
            }
            
            /* Mantener t√≠tulo con su contenido */
            .cost-summary-wrapper {
                page-break-inside: avoid !important;
            }
            
            .section-title {
                page-break-after: avoid !important;
            }
            
            /* Optimizar espaciado para aprovechar mejor el espacio */
            .itinerary-section {
                margin-bottom: 20px !important;
            }
            
            .section-title {
                margin-bottom: 12px !important;
                padding-bottom: 8px !important;
                page-break-after: avoid !important;
            }
            
            /* Reducir tama√±os para economizar espacio */
            .cost-summary {
                padding: 15px !important;
                margin-bottom: 15px !important;
            }
            
            .validity { 
                padding: 12px !important; 
                margin-bottom: 15px !important;
                font-size: 13px !important;
            }
            
            .payment-methods {
                margin-bottom: 15px !important;
            }
            
            .terms { 
                padding: 12px !important; 
                margin-bottom: 15px !important;
            }
            .terms h3 { 
                font-size: 14px !important; 
                margin-bottom: 8px !important;
            }
            .terms ul { 
                font-size: 10px !important; 
                line-height: 1.4 !important; 
                margin: 0 !important;
                padding-left: 18px !important;
            }
            .terms li {
                margin-bottom: 4px !important;
            }
            
            .doc-footer {
                padding-top: 15px !important;
                margin-top: 15px !important;
                font-size: 11px !important;
                page-break-inside: avoid !important;
            }
        `;
        clone.prepend(style);
        
        // Replace payment images with text (avoid CORS)
        const paymentSection = clone.querySelector('.payment-methods');
        if (paymentSection) {
            const paymentImages = paymentSection.querySelector('.payment-images');
            if (paymentImages) {
                paymentImages.innerHTML = `
                    <div style="text-align:center;padding:15px;background:#f8f9fa;border-radius:8px">
                        <p style="margin:5px 0"><strong>üí≥ Tarjetas:</strong> Visa, Mastercard</p>
                        <p style="margin:5px 0"><strong>üí∞ Transferencias:</strong> Yape, Plin</p>
                        <p style="margin:5px 0"><strong>üåê Internacional:</strong> PayPal, Western Union</p>
                    </div>
                `;
            }
        }
        
        // Configure options
        const vista2 = VISTA2_DATA || {};
        const totalDays = CART.reduce((acc, t) => acc + t.duration_days, 0);
        const clientName = vista2.clientName ? `_${vista2.clientName.replace(/\s+/g, '_')}` : '';
        const filename = `Itinerario_QoriWayra_${totalDays}dias${clientName}.pdf`;
        
        const opt = {
            margin: [10, 10, 10, 10],
            filename: filename,
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: { 
                scale: 2,
                useCORS: false,
                allowTaint: true,
                logging: false,
                letterRendering: true,
                backgroundColor: '#ffffff'
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait',
                compress: true
            },
            pagebreak: { 
                mode: ['avoid-all', 'css'],
                avoid: ['.first-page-content', '.doc-header', '.doc-title', '.client-info-section', '.day-item.first-day', '.day-item', '.includes-section', '.activity-list', '.cost-summary-wrapper', '.cost-summary', '.validity', '.payment-methods', '.terms', '.doc-footer', '.final-page-section']
            }
        };
        
        // Generate PDF
        await html2pdf().set(opt).from(clone).save();
        
        btnPDF.disabled = false;
        btnPDF.textContent = 'üì• Generar PDF';
        
    } catch (error) {
        console.error('Error completo:', error);
        btnPDF.disabled = false;
        btnPDF.textContent = 'üì• Generar PDF';
        alert('‚ùå Error al generar PDF: ' + error.message);
    }
}

// Helper function to convert hex to RGB
function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : { r: 102, g: 126, b: 234 };
}

// Initialize
updatePrimaryColor();
renderDocument();

// Click handlers for radio views
document.querySelectorAll('.radio-view').forEach(view => {
    view.addEventListener('click', function() {
        const input = this.querySelector('input[type="radio"]');
        if (input) {
            input.checked = true;
            selectView(input.value);
        }
    });
});
</script>
