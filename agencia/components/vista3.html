<style>
body { background: #f5f5f5; min-height: 100vh; margin: 0; font-family: Arial, sans-serif; }
.vista3-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
.vista3-header { background: #fff; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.header-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
.view-options { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
.radio-view { display: flex; align-items: center; gap: 10px; padding: 10px 20px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; background: #fff; }
.radio-view input { width: 18px; height: 18px; cursor: pointer; }
.radio-view.selected { border-color: #667eea; background: #f0f4ff; }
.color-picker-group { display: flex; align-items: center; gap: 10px; }
.color-picker-group label { font-weight: 600; color: #333; }
.color-picker-group input[type="color"] { width: 50px; height: 40px; border: 2px solid #e0e0e0; border-radius: 5px; cursor: pointer; }
.action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
.btn-back { background: #6c757d; color: white; }
.btn-edit { background: #ffc107; color: #333; }
.btn-pdf { background: #28a745; color: white; }
.btn-cancel { background: #dc3545; color: white; }
.btn-logout { background: #343a40; color: white; }
.document { background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.doc-header { border-bottom: 3px solid var(--primary-color, #667eea); padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; gap: 20px; }
.doc-header-left { display: flex; align-items: center; gap: 20px; }
.doc-logo-img { width: 100px; height: 100px; object-fit: contain; }
.doc-logo-text { display: flex; flex-direction: column; }
.doc-logo-title { font-size: 28px; font-weight: bold; color: #5b7fd4; }
.doc-logo-subtitle { font-size: 16px; color: #666; margin-top: 5px; }
.doc-header-right { text-align: right; color: #666; font-size: 14px; line-height: 1.8; }
.doc-header-right a { color: #5b7fd4; text-decoration: none; }
.doc-title { font-size: 24px; font-weight: bold; color: #333; text-align: center; margin-bottom: 30px; }
.itinerary-section { margin-bottom: 30px; }
.section-title { font-size: 20px; font-weight: bold; color: var(--primary-color, #667eea); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--primary-color, #667eea); }
.day-item { margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary-color, #667eea); }
.day-title { font-size: 18px; font-weight: bold; color: var(--primary-color, #667eea); margin-bottom: 10px; }
.tour-name-day { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 10px; }
.tour-image-detail { width: 100%; height: 200px; border-radius: 8px; object-fit: cover; margin-bottom: 15px; background: linear-gradient(135deg, #667eea, #764ba2); }
.tour-summary { color: #666; line-height: 1.6; margin-bottom: 15px; }
.includes-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
.includes-list { background: #fff; padding: 15px; border-radius: 8px; }
.includes-list h4 { color: #28a745; margin-bottom: 10px; font-size: 14px; }
.not-includes-list h4 { color: #dc3545; margin-bottom: 10px; font-size: 14px; }
.includes-list ul { list-style: none; padding: 0; margin: 0; }
.includes-list li { padding: 5px 0; font-size: 13px; color: #666; }
.not-includes-list { background: #fff; padding: 15px; border-radius: 8px; }
.not-includes-list ul { list-style: none; padding: 0; margin: 0; }
.not-includes-list li { padding: 5px 0; font-size: 13px; color: #666; }
.cost-summary { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.cost-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e0e0e0; }
.cost-total { display: flex; justify-content: space-between; padding: 15px 0; font-size: 20px; font-weight: bold; color: var(--primary-color, #667eea); margin-top: 10px; }
.validity { background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px; color: #856404; }
.payment-methods { margin-bottom: 20px; }
.payment-images { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
.payment-images img { height: 40px; border-radius: 5px; }
.terms { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.terms h3 { color: #333; margin-bottom: 15px; font-size: 18px; }
.terms ul { color: #666; line-height: 1.8; }
.doc-footer { border-top: 2px solid var(--primary-color, #667eea); padding-top: 20px; margin-top: 30px; text-align: center; color: #666; font-size: 12px; line-height: 1.6; }
.editable-mode { outline: 2px dashed #ffc107; background: #fffbf0; }
.activity-list { background: #fff; padding: 15px; border-radius: 8px; margin-top: 10px; margin-bottom: 15px; }
.activity-list h4 { color: #667eea; margin-bottom: 10px; font-size: 14px; }
.activity-list ul { list-style: none; padding: 0; margin: 0; }
.activity-list li { padding: 5px 0; font-size: 13px; color: #666; }
.activity-list li:before { content: "üìç "; }
@media (max-width: 768px) {
    .includes-section { grid-template-columns: 1fr; }
    .document { padding: 20px; }
    .action-buttons { width: 100%; }
    .btn { flex: 1; }
    .doc-header { flex-direction: column; text-align: center; }
    .doc-header-right { text-align: center; }
}
</style>

<div class="vista3-container">
    <div class="vista3-header">
        <div class="header-controls">
            <div class="view-options">
                <div class="radio-view selected" id="viewResumen" onclick="selectView('resumen')">
                    <input type="radio" name="viewType" value="resumen" checked>
                    <span>üìÑ Resumen</span>
                </div>
                <div class="radio-view" id="viewDetallado" onclick="selectView('detallado')">
                    <input type="radio" name="viewType" value="detallado">
                    <span>üìã Detallado</span>
                </div>
                <div class="color-picker-group">
                    <label>Color:</label>
                    <input type="color" id="primaryColor" value="#667eea" onchange="updatePrimaryColor()">
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-back" onclick="loadView('vista2')">‚Üê Anterior</button>
                <button class="btn btn-edit" id="btnEdit" onclick="toggleEditMode()">‚úèÔ∏è Editar</button>
                <button class="btn btn-pdf" onclick="alert('Funci√≥n de PDF pr√≥ximamente')">üì• Generar PDF</button>
                <button class="btn btn-cancel" onclick="confirmCancel()">‚ùå Cancelar</button>
                <button class="btn btn-logout" onclick="logout()">üö™ Salir</button>
            </div>
        </div>
    </div>
    
    <div class="document" id="documentContent"></div>
</div>

<script>
// Use global variables (no let/const)
currentView = 'resumen';
primaryColor = '#667eea';
isEditMode = false;

function toggleEditMode() {
    isEditMode = !isEditMode;
    const doc = document.getElementById('documentContent');
    const btn = document.getElementById('btnEdit');
    
    if (isEditMode) {
        doc.contentEditable = 'true';
        doc.classList.add('editable-mode');
        btn.innerHTML = '‚úÖ Terminar Edici√≥n';
        btn.style.background = '#28a745';
    } else {
        doc.contentEditable = 'false';
        doc.classList.remove('editable-mode');
        btn.innerHTML = '‚úèÔ∏è Editar';
        btn.style.background = '#ffc107';
    }
}

function selectView(view) {
    currentView = view;
    document.getElementById('viewResumen').classList.toggle('selected', view === 'resumen');
    document.getElementById('viewDetallado').classList.toggle('selected', view === 'detallado');
    document.querySelectorAll('input[name="viewType"]').forEach(radio => {
        radio.checked = radio.value === view;
    });
    renderDocument();
}

function updatePrimaryColor() {
    primaryColor = document.getElementById('primaryColor').value;
    document.documentElement.style.setProperty('--primary-color', primaryColor);
}

function renderDocument() {
    const vista2 = VISTA2_DATA || {};
    const currency = vista2.currency === 'USD' ? '$' : 'S/';
    const baseTotal = CART.reduce((acc, t) => acc + t.price, 0);
    const totalDays = CART.reduce((acc, t) => acc + t.duration_days, 0);
    const totalNights = totalDays - 1;
    
    let adultTotal = vista2.totalAmount || baseTotal;
    let childTotal = 0;
    
    if (vista2.includeBudgetChild) {
        const baseAmount = baseTotal;
        if (vista2.currency === 'USD') {
            adultTotal = baseAmount / 3.75;
            childTotal = (baseAmount * 0.5) / 3.75;
        } else {
            adultTotal = baseAmount;
            childTotal = baseAmount * 0.5;
        }
    }
    
    let currentDay = 1;
    let daysHTML = '';
    
    CART.forEach((tour, index) => {
        const days = tour.duration_days;
        const dayLabel = days === 1 ? `D√≠a ${currentDay}` : `D√≠as ${currentDay} - ${currentDay + days - 1}`;
        
        // Summary list (always show)
        const summaryList = tour.summary_list || [];
        const summaryHTML = summaryList.length > 0 ? `
            <div class="activity-list">
                <h4>üìã Itinerario:</h4>
                <ul>
                    ${summaryList.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
        ` : '';
        
        if (currentView === 'resumen') {
            daysHTML += `
                <div class="day-item">
                    <div class="day-title">${dayLabel}</div>
                    <div class="tour-name-day">${tour.name}</div>
                    ${summaryHTML}
                    ${renderIncludes(tour)}
                </div>
            `;
        } else {
            const imageName = tour.name.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/√±/g, 'n')
                .replace(/[\s\-‚Äì‚Äî]+/g, '_');
            const imageUrl = IMAGE_CACHE[tour.name] || `images/${imageName}/Principal.jpg`;
            
            daysHTML += `
                <div class="day-item">
                    <div class="day-title">${dayLabel}</div>
                    <div class="tour-name-day">${tour.name}</div>
                    <img src="${imageUrl}" class="tour-image-detail" alt="${tour.name}" onerror="this.style.background='linear-gradient(135deg, #667eea, #764ba2)'; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3C/svg%3E'">
                    <div class="tour-summary">${tour.summary || 'Disfruta de una experiencia √∫nica en este tour.'}</div>
                    ${summaryHTML}
                    ${renderIncludes(tour)}
                </div>
            `;
        }
        
        currentDay += days;
    });
    
    document.getElementById('documentContent').innerHTML = `
        <div class="doc-header">
            <div class="doc-header-left">
                <img src="images/logo.png" alt="Qori Wayra Logo" class="doc-logo-img" onerror="this.style.display='none'">
                <div class="doc-logo-text">
                    <div class="doc-logo-title">Qori Wayra - Travel</div>
                    <div class="doc-logo-subtitle">Experiencias √∫nicas en Cusco y Per√∫</div>
                </div>
            </div>
            <div class="doc-header-right">
                Tel: <a href="tel:+51924377454">+51 924 377 454</a><br>
                Web: <a href="https://qoriwayra-travel.com" target="_blank">qoriwayra-travel.com</a><br>
                Email: <a href="mailto:qoriwayra.cuscotravel@gmail.com">qoriwayra.cuscotravel@gmail.com</a><br>
                Instagram: <a href="https://instagram.com/qoriwayratravel" target="_blank">@qoriwayratravel</a>
            </div>
        </div>
        
        <div class="doc-title">ITINERARIO DE VIAJE<br><span style="font-size:18px;color:#666">${totalDays} d√≠a${totalDays > 1 ? 's' : ''} / ${totalNights} noche${totalNights > 1 ? 's' : ''}</span></div>
        
        ${vista2.includeClientData ? `
        <div class="section-title">üë§ Informaci√≥n del Cliente</div>
        <div class="cost-summary" style="margin-bottom:30px">
            <div class="cost-row">
                <span>Nombre:</span>
                <span>${vista2.clientName}</span>
            </div>
            <div class="cost-row">
                <span>Nacionalidad:</span>
                <span>${vista2.clientNationality ? vista2.clientNationality.split('|')[0] : ''}</span>
            </div>
            <div class="cost-row">
                <span>Contacto:</span>
                <span>${vista2.phonePrefix}${vista2.phoneNumber}</span>
            </div>
        </div>
        ` : ''}
        
        <div class="itinerary-section">
            <div class="section-title">üìÖ Cronograma</div>
            ${daysHTML}
        </div>
        
        <div class="section-title">üí∞ Resumen de Costos</div>
        <div class="cost-summary">
            <div class="cost-row">
                <span>Cantidad de Tours:</span>
                <span>${CART.length}</span>
            </div>
            <div class="cost-row">
                <span>Moneda:</span>
                <span>${vista2.currency === 'USD' ? 'D√≥lares (USD)' : 'Soles (PEN)'}</span>
            </div>
            ${vista2.includeBudgetChild ? `
            <div class="cost-total" style="margin-top:10px;padding-top:10px;border-top:2px solid #e0e0e0">
                <span>TOTAL ADULTO:</span>
                <span>${currency} ${adultTotal.toFixed(2)}</span>
            </div>
            <div class="cost-total" style="margin-top:0;padding-top:10px">
                <span>TOTAL NI√ëO:</span>
                <span>${currency} ${childTotal.toFixed(2)}</span>
            </div>
            <div class="cost-total" style="background:#f0f4ff;padding:15px;border-radius:8px;margin-top:10px">
                <span>TOTAL GENERAL:</span>
                <span>${currency} ${(adultTotal + childTotal).toFixed(2)}</span>
            </div>
            ` : `
            <div class="cost-total">
                <span>TOTAL A PAGAR:</span>
                <span>${currency} ${adultTotal.toFixed(2)}</span>
            </div>
            `}
        </div>
        
        <div class="validity">
            ‚è∞ <strong>Validez:</strong> Este presupuesto tiene una validez de 2 d√≠as desde su emisi√≥n.
        </div>
        
        <div class="payment-methods">
            <div class="section-title">üí≥ M√©todos de Pago</div>
            <div class="payment-images">
                <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png" alt="Visa">
                <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard">
                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal">
                <img src="https://images.seeklogo.com/logo-png/49/1/western-union-2023-logo-png_seeklogo-499195.png" alt="Western Union">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/76/Yape_peru_logotype.svg/1200px-Yape_peru_logotype.svg.png" alt="Yape">
            </div>
        </div>
        
        <div class="terms">
            <h3>üìã T√©rminos y Condiciones</h3>
            <ul>
                <li><strong>Adelanto:</strong> Se requiere el 50% del monto total como adelanto para confirmar la reserva.</li>
                <li><strong>Pagos internacionales:</strong> Los pagos con tarjetas extranjeras mediante PayPal u otros medios internacionales tienen un recargo del 5% al 10% seg√∫n el m√©todo.</li>
                <li><strong>Reembolsos:</strong> Las cancelaciones con m√°s de 7 d√≠as de anticipaci√≥n tienen derecho a reembolso del 80% del adelanto. Cancelaciones con menos de 7 d√≠as no son reembolsables.</li>
                <li><strong>Cambios clim√°ticos:</strong> En caso de condiciones clim√°ticas adversas, se reprogramar√° el tour sin costo adicional o se proceder√° al reembolso completo.</li>
                <li><strong>Cambios de fecha por el cliente:</strong> Si el cliente necesita modificar las fechas de viaje o presenta imprevistos personales, haremos nuestro mejor esfuerzo para reprogramar. Sin embargo, la disponibilidad est√° sujeta a los proveedores de servicios y pueden aplicarse cargos adicionales.</li>
                <li><strong>Responsabilidad:</strong> La empresa no se hace responsable por cambios en los planes de viaje debido a causas ajenas a nuestro control, tales como cambios de vuelos, demoras, o circunstancias personales del cliente.</li>
                <li><strong>Disponibilidad:</strong> Todos los tours est√°n sujetos a disponibilidad y confirmaci√≥n.</li>
                <li><strong>Documentaci√≥n:</strong> Es responsabilidad del cliente contar con la documentaci√≥n necesaria (pasaporte, visas, etc.).</li>
            </ul>
        </div>
        
        <div class="doc-footer">
            <strong>Documento generado por Qori Wayra - Travel</strong><br>
            Todos los tours est√°n sujetos a disponibilidad y condiciones clim√°ticas<br>
            Para m√°s informaci√≥n, cont√°ctenos a trav√©s de nuestros canales oficiales
        </div>
    `;
}

function renderIncludes(tour) {
    const includes = tour.includes || [];
    const notIncludes = tour.excludes || tour.not_includes || [];
    
    return `
        <div class="includes-section">
            <div class="includes-list">
                <h4>‚úì Incluye:</h4>
                <ul>
                    ${includes.length > 0 ? includes.map(item => `<li>${getEmojiForItem(item, true)} ${item}</li>`).join('') : '<li>No especificado</li>'}
                </ul>
            </div>
            <div class="not-includes-list">
                <h4>‚úó No Incluye:</h4>
                <ul>
                    ${notIncludes.length > 0 ? notIncludes.map(item => `<li>${getEmojiForItem(item, false)} ${item}</li>`).join('') : '<li>No especificado</li>'}
                </ul>
            </div>
        </div>
    `;
}

function confirmCancel() {
    if (confirm('¬øEst√°s seguro de que deseas cancelar? Se perder√°n todos los datos.')) {
        clearAllData();
        loadView('vistatours');
    }
}

// Initialize
updatePrimaryColor();
renderDocument();

// Click handlers for radio views
document.querySelectorAll('.radio-view').forEach(view => {
    view.addEventListener('click', function() {
        const input = this.querySelector('input[type="radio"]');
        if (input) {
            input.checked = true;
            selectView(input.value);
        }
    });
});
</script>
