<style>
body { background: #f5f7fa; min-height: 100vh; margin: 0; }
.tours-view { max-width: 1600px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 1fr 350px; gap: 30px; min-height: calc(100vh - 80px); }
.tours-header { grid-column: 1/-1; color: #2c3e50; font-size: 28px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
.user-welcome { color: #64748b; font-size: 16px; }
.filters { grid-column: 1/-1; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; }
.filter-group { display: flex; flex-direction: column; gap: 5px; }
.filter-group label { font-weight: 600; font-size: 14px; }
.filter-group input, .filter-group select { padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
.tours-section { grid-column: 1; }
.tours-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
.tour-card { background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s; }
.tour-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
.tour-card.selected { border: 3px solid #667eea; }
.tour-image { position: relative; height: 180px; background: linear-gradient(135deg, #667eea, #764ba2); overflow: hidden; }
.tour-image .overlay { position: absolute; inset: 0; background: rgba(102,126,234,0.9); display: flex; align-items: center; justify-content: center; font-size: 60px; color: #fff; opacity: 0; transition: opacity 0.3s; }
.tour-card:hover .overlay { opacity: 1; }
.tour-image .badge { position: absolute; top: 10px; left: 10px; width: 30px; height: 30px; border-radius: 50%; background: #667eea; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; opacity: 0; }
.tour-card.selected .badge { opacity: 1; }
.tour-info { padding: 15px; }
.tour-info h3 { font-size: 16px; margin-bottom: 8px; color: #333; min-height: 40px; }
.tour-info p { color: #666; font-size: 14px; margin: 4px 0; }
.tour-info .price { color: #667eea; font-weight: bold; font-size: 18px; margin-top: 8px; }
.cart-sidebar { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 100px; display: flex; flex-direction: column; max-height: calc(100vh - 120px); }
.cart-header { padding: 20px; border-bottom: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
.cart-header h3 { font-size: 18px; display: flex; align-items: center; gap: 8px; }
.cart-badge { width: 28px; height: 28px; border-radius: 50%; background: #667eea; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; }
.cart-content { flex: 1; overflow-y: auto; padding: 20px; }
.empty-cart { text-align: center; padding: 40px 20px; color: #999; }
.empty-cart div { font-size: 50px; margin-bottom: 10px; }
.cart-item { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
.cart-item-info { display: flex; align-items: center; gap: 10px; }
.cart-item-num { width: 28px; height: 28px; border-radius: 50%; background: #667eea; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; }
.cart-item-name { font-weight: 600; font-size: 14px; }
.cart-item-price { color: #667eea; font-weight: 600; }
.btn-remove { border: none; background: #dc3545; color: #fff; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 16px; }
.cart-footer { padding: 20px; border-top: 2px solid #e0e0e0; }
.cart-total { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: 600; font-size: 18px; }
.cart-total span:last-child { color: #667eea; font-size: 22px; }
.btn-continue { width: 100%; padding: 14px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; }
.btn-continue:disabled { opacity: 0.5; cursor: not-allowed; }
.floating-cart-btn { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 16px 32px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 50px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.3); z-index: 999; }
.floating-cart-btn:disabled { opacity: 0.5; }
@media (max-width: 1024px) {
    .tours-view { grid-template-columns: 1fr; padding-bottom: 100px; }
    .cart-sidebar { display: none; }
    .filters { grid-template-columns: 1fr; }
    .floating-cart-btn { display: block; }
}
</style>

<div class="tours-view">
    <div class="tours-header">
        <div>üó∫Ô∏è Tours Disponibles</div>
        <div class="user-welcome">Hola, <span id="userName"></span></div>
    </div>
    
    <div class="filters">
        <div class="filter-group">
            <label>üîç Buscar</label>
            <input type="text" id="searchFilter" placeholder="Buscar tours...">
        </div>
        <div class="filter-group">
            <label>Ordenar</label>
            <select id="sortFilter">
                <option value="name">Nombre A-Z</option>
                <option value="price-asc">Precio: Menor</option>
                <option value="price-desc">Precio: Mayor</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Duraci√≥n</label>
            <select id="durationFilter">
                <option value="all">Todas</option>
                <option value="1">1 d√≠a</option>
                <option value="2">2 d√≠as</option>
                <option value="3">3 d√≠as</option>
                <option value="4">4+ d√≠as</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Precio</label>
            <select id="priceFilter">
                <option value="all">Todos</option>
                <option value="0-100">S/ 0-100</option>
                <option value="100-200">S/ 100-200</option>
                <option value="200+">S/ 200+</option>
            </select>
        </div>
    </div>
    
    <div class="tours-section">
        <div class="tours-grid" id="toursGrid"></div>
    </div>
    
    <div class="cart-sidebar">
        <div class="cart-header">
            <h3>üõí Mi Itinerario</h3>
            <div class="cart-badge" id="cartBadge">0</div>
        </div>
        <div class="cart-content" id="cartContent">
            <div class="empty-cart">
                <div>üìã</div>
                <p>No hay tours seleccionados</p>
            </div>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>TOTAL:</span>
                <span id="cartTotal">S/ 0.00</span>
            </div>
            <button class="btn-continue" id="btnContinue" onclick="goToVista1()" disabled>Ver Itinerario ‚Üí</button>
        </div>
    </div>
    
    <button class="floating-cart-btn" id="floatingCartBtn" onclick="goToVista1()" disabled>
        üõí Ver Itinerario (<span id="floatingBadge">0</span>) - S/ <span id="floatingTotal">0.00</span>
    </button>
</div>

<script>
document.getElementById('userName').textContent = USER;
renderTours();
updateCart();

document.getElementById('searchFilter').addEventListener('input', filterTours);
document.getElementById('sortFilter').addEventListener('change', filterTours);
document.getElementById('durationFilter').addEventListener('change', filterTours);
document.getElementById('priceFilter').addEventListener('change', filterTours);

function renderTours() {
    const grid = document.getElementById('toursGrid');
    if (!grid) return;
    
    grid.innerHTML = TOURS.map((tour, i) => {
        const selected = CART.some(item => item.index === i);
        const cartIndex = selected ? CART.findIndex(item => item.index === i) + 1 : '';
        
        return `
            <div class="tour-card ${selected ? 'selected' : ''}" onclick="addToCart(${i})">
                <div class="tour-image" id="tour-img-${i}" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <span class="badge">${cartIndex}</span>
                    <div class="overlay">+</div>
                </div>
                <div class="tour-info">
                    <h3>${tour.name}</h3>
                    <p>üìÖ ${tour.duration_days} d√≠a${tour.duration_days > 1 ? 's' : ''}</p>
                    <p class="price">S/ ${tour.price.toFixed(2)}</p>
                </div>
            </div>
        `;
    }).join('');
    
    // Load images with cache
    TOURS.forEach((tour, i) => {
        loadTourImageWithCache(i, tour.name);
    });
}

function loadTourImageWithCache(index, tourName) {
    // Check cache first
    if (IMAGE_CACHE[tourName]) {
        const imgElement = document.getElementById(`tour-img-${index}`);
        if (imgElement) {
            imgElement.style.background = `url('${IMAGE_CACHE[tourName]}') center/cover`;
        }
        return;
    }
    
    // If not in cache, search for image
    const imageName = tourName.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/√±/g, 'n')
        .replace(/[\s\-‚Äì‚Äî]+/g, '_');
    
    const formats = ['webp', 'jpg', 'jpeg', 'png'];
    const imgElement = document.getElementById(`tour-img-${index}`);
    if (!imgElement) return;
    
    let loaded = false;
    
    function tryFormat(formatIndex) {
        if (loaded || formatIndex >= formats.length) return;
        
        const img = new Image();
        const url = `images/${imageName}/Principal.${formats[formatIndex]}`;
        
        img.onload = function() {
            if (!loaded) {
                loaded = true;
                imgElement.style.background = `url('${url}') center/cover`;
                // Save to cache
                IMAGE_CACHE[tourName] = url;
                saveImageCache();
            }
        };
        
        img.onerror = function() {
            if (!loaded) {
                tryFormat(formatIndex + 1);
            }
        };
        
        img.src = url;
    }
    
    tryFormat(0);
}

function updateCart() {
    const cartContent = document.getElementById('cartContent');
    const badge = document.getElementById('cartBadge');
    const total = document.getElementById('cartTotal');
    const btn = document.getElementById('btnContinue');
    const floatingBtn = document.getElementById('floatingCartBtn');
    const floatingBadge = document.getElementById('floatingBadge');
    const floatingTotal = document.getElementById('floatingTotal');
    
    if (badge) badge.textContent = CART.length;
    if (floatingBadge) floatingBadge.textContent = CART.length;
    if (btn) btn.disabled = CART.length === 0;
    if (floatingBtn) floatingBtn.disabled = CART.length === 0;
    
    const sum = CART.reduce((acc, t) => acc + t.price, 0);
    if (total) total.textContent = `S/ ${sum.toFixed(2)}`;
    if (floatingTotal) floatingTotal.textContent = sum.toFixed(2);
    
    if (cartContent) {
        if (CART.length === 0) {
            cartContent.innerHTML = `
                <div class="empty-cart">
                    <div>üìã</div>
                    <p>No hay tours seleccionados</p>
                </div>
            `;
        } else {
            cartContent.innerHTML = CART.map((t, i) => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-num">${i + 1}</div>
                        <div>
                            <div class="cart-item-name">${t.name}</div>
                            <div class="cart-item-price">S/ ${t.price.toFixed(2)}</div>
                        </div>
                    </div>
                    <button class="btn-remove" onclick="addToCart(${t.index})">√ó</button>
                </div>
            `).join('');
        }
    }
}

function filterTours() {
    const search = document.getElementById('searchFilter').value.toLowerCase();
    const sort = document.getElementById('sortFilter').value;
    const duration = document.getElementById('durationFilter').value;
    const price = document.getElementById('priceFilter').value;
    
    let filtered = [...TOURS];
    
    if (search) {
        filtered = filtered.filter(t => t.name.toLowerCase().includes(search));
    }
    
    if (duration !== 'all') {
        const d = parseInt(duration);
        filtered = filtered.filter(t => duration === '4' ? t.duration_days >= 4 : t.duration_days === d);
    }
    
    if (price !== 'all') {
        const [min, max] = price.split('-').map(p => p === '+' ? Infinity : parseInt(p));
        filtered = filtered.filter(t => t.price >= min && t.price <= (max || Infinity));
    }
    
    if (sort === 'price-asc') filtered.sort((a, b) => a.price - b.price);
    if (sort === 'price-desc') filtered.sort((a, b) => b.price - a.price);
    if (sort === 'name') filtered.sort((a, b) => a.name.localeCompare(b.name));
    
    TOURS = filtered;
    renderTours();
}
</script>
