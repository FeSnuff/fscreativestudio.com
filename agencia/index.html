<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tours App</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; }
        #app { min-height: 100vh; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxgnj4XWyRHZewUrmUKWeDsyJ_6HrlUwivjVAeTUjzGGoz-wwanibcNDUL7XrWDDUDm8A/exec';
        
        // VARIABLES GLOBALES
        let USER = null;
        let TOURS = [];
        let CART = [];
        let IMAGE_CACHE = {};
        let VISTA2_DATA = null;
        let VISTA3_DATA = null;
        
        // Variables de estado de vistas
        let currentCurrency = 'PEN';
        let currentView = 'resumen';
        let primaryColor = '#667eea';
        let isEditMode = false;
        
        // Initialize emoji mappings only once
        window.EMOJI_INCLUDE = window.EMOJI_INCLUDE || {
            'almuerzo': 'üçΩÔ∏è', 'asistencia': 'üë®‚Äç‚öïÔ∏è', 'oxigeno': 'üí®', 'bal√≥n': 'üí®',
            'bastones': 'ü•æ', 'botiquin': 'ü©π', 'primeros auxilios': 'ü©π',
            'practica': 'üèÉ', 'bus': 'üöå', 'casco': '‚õëÔ∏è', 'equipo': 'üéí', 'seguridad': '‚õëÔ∏è',
            'cuatrimoto': 'üèçÔ∏è', 'desayuno': 'üç≥', 'guia': 'üë®‚Äçüè´', 'profesional': 'üë®‚Äçüè´',
            'recojo': 'üöê', 'hotel': 'üè®', 'ticket': 'üé´', 'tren': 'üöÇ',
            'ingreso': 'üéüÔ∏è', 'transporte': 'üöó', 'turistico': 'üöå', 'tur√≠stico': 'üöå',
            'subida': '‚¨ÜÔ∏è', 'bajada': '‚¨áÔ∏è', 'machupicchu': 'üèõÔ∏è', 'machu picchu': 'üèõÔ∏è',
            'ida': '‚û°Ô∏è', 'retorno': '‚¨ÖÔ∏è', 'vuelta': '‚¨ÖÔ∏è', 'doble': 'üë•', 'individual': 'üë§'
        };
        
        window.EMOJI_NOT_INCLUDE = window.EMOJI_NOT_INCLUDE || {
            'alimentacion': 'üç¥', 'alimentaci√≥n': 'üç¥', 'btp': 'üé´', 'boleto': 'üéüÔ∏è',
            'caballo': 'üê¥', 'cena': 'üçΩÔ∏è', 'entrada': 'üö™', 'salineras': 'üßÇ',
            'hospedaje': 'üè®', 'igv': 'üí∞', 'ingreso': 'üéüÔ∏è', 'capilla': '‚õ™',
            'lagunas': 'üèûÔ∏è', '7 lagunas': 'üèûÔ∏è', 'termales': '‚ô®Ô∏è', 'pitumarca': 'üèîÔ∏è',
            'seguro': 'üõ°Ô∏è', 'personal': 'üõ°Ô∏è', 'tiket': 'üé´', 'ticket': 'üé´',
            'waqrapukara': 'üèîÔ∏è', 'cusco': 'üèôÔ∏è', 'machupicchu': 'üèõÔ∏è'
        };
        
        // Emoji getter function (global)
        window.getEmojiForItem = function(text, isInclude) {
            const lowerText = text.toLowerCase();
            const emojiMap = isInclude ? window.EMOJI_INCLUDE : window.EMOJI_NOT_INCLUDE;
            
            for (const [key, emoji] of Object.entries(emojiMap)) {
                if (lowerText.includes(key)) {
                    return emoji;
                }
            }
            return isInclude ? '‚úÖ' : '‚ùå';
        };
        
        // Encode itinerary to compact string
        window.encodeItinerary = function() {
            const tourIndices = CART.map(tour => TOURS.findIndex(t => t.name === tour.name)).join(',');
            const vista2 = VISTA2_DATA || {};
            
            const data = {
                tours: tourIndices,
                currency: vista2.currency || 'PEN',
                child: vista2.includeBudgetChild ? '1' : '0',
                adultTotal: vista2.adultTotal || 0,
                childTotal: vista2.childTotal || 0,
                color: primaryColor.replace('#', ''),
                view: currentView,
                clientData: vista2.includeClientData ? '1' : '0'
            };
            
            const compact = `${data.tours}|${data.currency}|${data.child}|${data.adultTotal}|${data.childTotal}|${data.color}|${data.view}|${data.clientData}`;
            return btoa(compact); // Base64 encode
        };
        
        // Decode itinerary from string
        window.decodeItinerary = function(encoded) {
            try {
                const compact = atob(encoded); // Base64 decode
                const parts = compact.split('|');
                
                return {
                    tourIndices: parts[0].split(',').map(Number),
                    currency: parts[1],
                    includeBudgetChild: parts[2] === '1',
                    adultTotal: parseFloat(parts[3]),
                    childTotal: parseFloat(parts[4]),
                    color: '#' + parts[5],
                    view: parts[6],
                    includeClientData: parts[7] === '1'
                };
            } catch (error) {
                console.error('Error decoding itinerary:', error);
                return null;
            }
        };

        // CARGAR DATOS PERSISTENTES
        function loadPersistedData() {
            try {
                const cachedImages = localStorage.getItem('imageCache');
                if (cachedImages) IMAGE_CACHE = JSON.parse(cachedImages);
                
                const vista2 = localStorage.getItem('vista2Data');
                if (vista2) VISTA2_DATA = JSON.parse(vista2);
                
                const cart = localStorage.getItem('cart');
                if (cart) CART = JSON.parse(cart);
            } catch (e) {
                console.error('Error loading persisted data:', e);
            }
        }

        // GUARDAR DATOS EN LOCALSTORAGE
        function saveImageCache() {
            try {
                localStorage.setItem('imageCache', JSON.stringify(IMAGE_CACHE));
            } catch (e) {
                console.error('Error saving image cache:', e);
            }
        }

        function saveVista2Data(data) {
            VISTA2_DATA = data;
            try {
                localStorage.setItem('vista2Data', JSON.stringify(data));
            } catch (e) {
                console.error('Error saving vista2 data:', e);
            }
        }

        function saveCart() {
            try {
                localStorage.setItem('cart', JSON.stringify(CART));
            } catch (e) {
                console.error('Error saving cart:', e);
            }
        }

        // LIMPIAR TODOS LOS DATOS
        function clearAllData() {
            CART = [];
            VISTA2_DATA = null;
            VISTA3_DATA = null;
            localStorage.removeItem('cart');
            localStorage.removeItem('vista2Data');
            localStorage.removeItem('vista3Data');
        }

        // CARGAR VISTA
        async function loadView(viewName) {
            const response = await fetch(`components/${viewName}.html`);
            const html = await response.text();
            document.getElementById('app').innerHTML = html;
            
            const scripts = document.getElementById('app').querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                newScript.textContent = oldScript.textContent;
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        }

        // CARGAR TOURS
        async function loadTours() {
            try {
                const res = await fetch('tours.json');
                TOURS = await res.json();
            } catch (e) {
                TOURS = [];
            }
        }

        // LOGIN
        async function login(username, password) {
            const url = `${SCRIPT_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success) {
                USER = username;
                localStorage.setItem('user', username);
                await loadTours();
                await showSuccess();
            } else {
                throw new Error(data.message || 'Usuario o contrase√±a incorrectos');
            }
        }

        async function showSuccess() {
            await loadView('vistatours');
        }

        // LOGOUT
        function logout() {
            localStorage.removeItem('user');
            location.reload();
        }

        // CART MANAGEMENT
        function addToCart(index) {
            const exists = CART.findIndex(item => item.index === index);
            if (exists !== -1) {
                CART.splice(exists, 1);
            } else {
                CART.push({ index, ...TOURS[index] });
            }
            saveCart();
            if (typeof renderTours === 'function') renderTours();
            if (typeof updateCart === 'function') updateCart();
        }

        // NAVEGACION
        async function goToVista1() {
            await loadView('vista1');
        }

        async function goToVista2() {
            await loadView('vista2');
        }

        async function goToVista3() {
            await loadView('vista3');
        }

        // DETECTAR SI ES RECARGA DE P√ÅGINA
        let isPageReload = performance.navigation.type === 1 || 
                          (performance.getEntriesByType('navigation')[0] && 
                           performance.getEntriesByType('navigation')[0].type === 'reload');

        // INICIALIZAR
        async function init() {
            // Si es F5/reload, limpiar datos excepto user e imageCache
            if (isPageReload) {
                localStorage.removeItem('cart');
                localStorage.removeItem('vista2Data');
                localStorage.removeItem('vista3Data');
                CART = [];
                VISTA2_DATA = null;
                VISTA3_DATA = null;
            }
            
            loadPersistedData();
            USER = localStorage.getItem('user');
            
            if (USER) {
                await loadTours();
                await showSuccess();
            } else {
                await loadView('login');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
