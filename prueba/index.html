<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tours & Aventuras - Qori Wayra Travel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #navbar-container,
        #footer-container {
            animation: fadeIn 0.5s ease;
        }

        #main-content {
            flex: 1;
            padding: 20px;
        }

        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            color: white;
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loader p {
            margin-top: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .error-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            max-width: 500px;
            margin: 100px auto;
        }

        .error-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            color: #dc3545;
            margin-bottom: 10px;
        }

        .error-message {
            color: #666;
            line-height: 1.6;
        }

        .btn-retry {
            margin-top: 20px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-retry:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Navbar -->
        <div id="navbar-container"></div>
        
        <!-- Main Content -->
        <main id="main-content">
            <div class="loader">
                <div class="loader-spinner"></div>
                <p>Cargando aplicaci√≥n...</p>
            </div>
        </main>
        
        <!-- Footer -->
        <div id="footer-container"></div>
    </div>

    <script>
        // ===== APP CONSTRUCTOR =====
        class ToursApp {
            constructor() {
                this.currentView = 'login';
                this.user = null;
                this.tours = [];      // Tours data from Google Sheets
                this.cart = [];       // Selected tours
                this.sheetsUrl = 'TU_URL_DE_GOOGLE_SHEETS_AQUI'; // ‚Üê CAMBIA ESTO
                this.init();
            }
            
            async init() {
                console.log('üöÄ Iniciando aplicaci√≥n...');
                
                try {
                    // 1. Load tours data FIRST (from Google Sheets)
                    await this.loadToursData();
                    
                    // 2. Load navbar and footer
                    await this.loadComponent('navbar', 'navbar-container');
                    await this.loadComponent('footer', 'footer-container');
                    
                    // 3. Check if user is logged in
                    this.user = localStorage.getItem('toursAppUser');
                    
                    if (this.user) {
                        console.log('‚úÖ Usuario encontrado:', this.user);
                        this.updateNavbar();
                        await this.loadComponent('catalog', 'main-content');
                    } else {
                        console.log('‚ÑπÔ∏è No hay usuario, cargando login...');
                        await this.loadComponent('login', 'main-content');
                    }
                    
                    console.log('‚úÖ Aplicaci√≥n cargada correctamente');
                } catch (error) {
                    console.error('‚ùå Error al iniciar aplicaci√≥n:', error);
                    this.showError('Error al cargar la aplicaci√≥n', error.message);
                }
            }
            
            async loadToursData() {
                try {
                    console.log('üì¶ Cargando tours desde Google Sheets...');
                    
                    const response = await fetch(this.sheetsUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    this.tours = await response.json();
                    console.log(`‚úÖ ${this.tours.length} tours cargados globalmente`);
                    
                    // Validate data structure
                    if (!Array.isArray(this.tours) || this.tours.length === 0) {
                        throw new Error('Los datos no tienen el formato correcto o est√°n vac√≠os');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error cargando tours:', error);
                    
                    // Show error with retry option
                    const mainContent = document.getElementById('main-content');
                    mainContent.innerHTML = `
                        <div class="error-container">
                            <div class="error-icon">‚ö†Ô∏è</div>
                            <h2 class="error-title">Error al cargar tours</h2>
                            <p class="error-message">${error.message}</p>
                            <p class="error-message" style="margin-top: 15px; font-size: 13px;">
                                Verifica que la URL de Google Sheets est√© correcta en index.html
                            </p>
                            <button class="btn-retry" onclick="location.reload()">
                                üîÑ Reintentar
                            </button>
                        </div>
                    `;
                    
                    throw error; // Stop initialization
                }
            }
            
            async loadComponent(componentName, containerId) {
                try {
                    console.log(`üì¶ Cargando componente: ${componentName}...`);
                    
                    const response = await fetch(`components/${componentName}.html`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const html = await response.text();
                    const container = document.getElementById(containerId);
                    
                    if (!container) {
                        throw new Error(`Contenedor no encontrado: ${containerId}`);
                    }
                    
                    container.innerHTML = html;
                    
                    // Execute scripts in the loaded component
                    this.executeScripts(container);
                    
                    console.log(`‚úÖ Componente ${componentName} cargado`);
                    
                } catch (error) {
                    console.error(`‚ùå Error cargando ${componentName}:`, error);
                    throw error;
                }
            }
            
            executeScripts(container) {
                const scripts = container.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });
                    newScript.textContent = oldScript.textContent;
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
            }
            
            updateNavbar() {
                const userName = document.getElementById('userName');
                const userInitial = document.getElementById('userInitial');
                const btnLogout = document.getElementById('btnLogout');
                
                if (this.user) {
                    if (userName) userName.textContent = this.user;
                    if (userInitial) userInitial.textContent = this.user.charAt(0).toUpperCase();
                    if (btnLogout) btnLogout.style.display = 'flex';
                } else {
                    if (userName) userName.textContent = 'Invitado';
                    if (userInitial) userInitial.textContent = '?';
                    if (btnLogout) btnLogout.style.display = 'none';
                }
            }
            
            async login(userName, userEmail) {
                this.user = userName;
                localStorage.setItem('toursAppUser', userName);
                if (userEmail) {
                    localStorage.setItem('toursAppEmail', userEmail);
                }
                
                this.updateNavbar();
                await this.loadComponent('catalog', 'main-content');
            }
            
            logout() {
                if (confirm('¬øEst√°s seguro de cerrar sesi√≥n?')) {
                    this.user = null;
                    this.cart = [];
                    localStorage.removeItem('toursAppUser');
                    localStorage.removeItem('toursAppEmail');
                    
                    this.updateNavbar();
                    this.loadComponent('login', 'main-content');
                }
            }
            
            showError(title, message) {
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = `
                    <div class="error-container">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <h2 class="error-title">${title}</h2>
                        <p class="error-message">${message}</p>
                        <button class="btn-retry" onclick="location.reload()">
                            üîÑ Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // Initialize app globally
        let app;
        window.addEventListener('load', () => {
            app = new ToursApp();
        });

        console.log('üì± Index.html cargado');
    </script>
</body>
</html>
